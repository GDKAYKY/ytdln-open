â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    YTDLN REST API - ARQUITETURA COMPLETA                       â•‘
â•‘                          Node.js + yt-dlp + ffmpeg                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ“Š FLUXO ARQUITETURAL GERAL

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE (Browser/Extension)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  POST /api  â”‚  â”‚  GET /api   â”‚  â”‚ EventSource  â”‚  â”‚ WebSocket        â”‚  â”‚
â”‚  â”‚  /download  â”‚  â”‚ /download   â”‚  â”‚ (SSE) para   â”‚  â”‚ (Alternativa)    â”‚  â”‚
â”‚  â”‚             â”‚  â”‚ /status/:id â”‚  â”‚ progresso    â”‚  â”‚                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                â”‚                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ HTTP/S         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â–¼                â–¼                                        â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚          â”‚      EXPRESS SERVER (9000)       â”‚                              â”‚
â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                              â”‚
â”‚          â”‚  â”‚   Router                     â”‚â”‚                              â”‚
â”‚          â”‚  â”‚  â€¢ POST /api/download        â”‚â”‚                              â”‚
â”‚          â”‚  â”‚  â€¢ GET /api/download/status  â”‚â”‚                              â”‚
â”‚          â”‚  â”‚  â€¢ GET /api/download/:id/sse â”‚â”‚                              â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                              â”‚
â”‚          â”‚             â”‚                    â”‚                              â”‚
â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                              â”‚
â”‚          â”‚  â”‚   Controller Layer          â”‚â”‚                              â”‚
â”‚          â”‚  â”‚  â€¢ ValidaÃ§Ãµes               â”‚â”‚                              â”‚
â”‚          â”‚  â”‚  â€¢ OrquestraÃ§Ã£o             â”‚â”‚                              â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                              â”‚
â”‚          â”‚             â”‚                    â”‚                              â”‚
â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                              â”‚
â”‚          â”‚  â”‚   Service Layer             â”‚â”‚                              â”‚
â”‚          â”‚  â”‚  â€¢ DownloadQueue            â”‚â”‚                              â”‚
â”‚          â”‚  â”‚  â€¢ DownloadManager          â”‚â”‚                              â”‚
â”‚          â”‚  â”‚  â€¢ ProgressTracker          â”‚â”‚                              â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                        â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              â”‚              â”‚            â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MEMORY    â”‚  â”‚  REDIS     â”‚  â”‚  FILE  â”‚ â”‚  FFMPEG    â”‚
    â”‚  STORE     â”‚  â”‚  (Cache)   â”‚  â”‚  SYSTEMâ”‚ â”‚ SUBPROCESS â”‚
    â”‚            â”‚  â”‚            â”‚  â”‚        â”‚ â”‚            â”‚
    â”‚ (Map)      â”‚  â”‚ {taskId:   â”‚  â”‚ /tmp   â”‚ â”‚ yt-dlp +   â”‚
    â”‚            â”‚  â”‚  progress} â”‚  â”‚        â”‚ â”‚ ffmpeg     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ (Opcional)
    â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   DATABASE   â”‚
  â”‚   (PostgreSQL)
  â”‚   ou SQLite  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


## ğŸ“¡ FLUXO DE UM DOWNLOAD COMPLETO

1ï¸âƒ£  CLIENTE INICIA DOWNLOAD
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Browser                                             â”‚
    â”‚  fetch('POST /api/download', {                       â”‚
    â”‚    url: 'https://example.com/video',                â”‚
    â”‚    format: 'best',                                   â”‚
    â”‚    outputPath: '/downloads'                          â”‚
    â”‚  })                                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ HTTP POST
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Express Server                                      â”‚
    â”‚  POST /api/download                                  â”‚
    â”‚  â€¢ Validar entrada                                   â”‚
    â”‚  â€¢ Gerar taskId Ãºnico                                â”‚
    â”‚  â€¢ Retornar taskId ao cliente                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  DownloadQueue (Sistema de Fila)                     â”‚
    â”‚  â€¢ Adicionar tarefa Ã  fila                           â”‚
    â”‚  â€¢ Processar em background (Worker Thread)           â”‚
    â”‚  â€¢ NÃ£o bloqueia thread principal (Express)           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚


2ï¸âƒ£  PROCESSAMENTO EM BACKGROUND (Worker)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Worker Loop                                         â”‚
    â”‚  while (taskQueue.length > 0)                        â”‚
    â”‚  â”œâ”€ Pegar prÃ³xima tarefa                             â”‚
    â”‚  â”œâ”€ Status: "starting"                               â”‚
    â”‚  â””â”€ Executar ytdlp + ffmpeg                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ProgressTracker                                     â”‚
    â”‚  Recebe output de ytdlp:                             â”‚
    â”‚  "[download] 10% of 100MiB at 5MiB/s ETA 00:19"     â”‚
    â”‚  â€¢ Parse %                                           â”‚
    â”‚  â€¢ Parse velocidade                                  â”‚
    â”‚  â€¢ Parse ETA                                         â”‚
    â”‚  â€¢ Parse fase (downloading/merging/done)             â”‚
    â”‚  â€¢ Armazena em MemoryStore {taskId: progress}        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚


3ï¸âƒ£  CLIENTE CONSULTA PROGRESSO (Polling ou SSE)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Browser                                             â”‚
    â”‚  const eventSource = new EventSource(                â”‚
    â”‚    '/api/download/:taskId/sse'                       â”‚
    â”‚  )                                                   â”‚
    â”‚  eventSource.onmessage = (e) => {                    â”‚
    â”‚    const progress = JSON.parse(e.data)               â”‚
    â”‚    updateProgressBar(progress.percent)               â”‚
    â”‚  }                                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ Server-Sent Events
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Express Server                                      â”‚
    â”‚  GET /api/download/:taskId/sse                       â”‚
    â”‚  â€¢ Manter conexÃ£o HTTP aberta                        â”‚
    â”‚  â€¢ Enviar progresso em tempo real                    â”‚
    â”‚  â€¢ Nunca fecha atÃ© tarefa terminar                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


4ï¸âƒ£  DOWNLOAD COMPLETO
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Worker - Arquivo Finalizado                         â”‚
    â”‚  â€¢ yt-dlp termina                                    â”‚
    â”‚  â€¢ ffmpeg termina merging                            â”‚
    â”‚  â€¢ Arquivo escrito em /tmp ou /downloads             â”‚
    â”‚  â€¢ Status: "completed"                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ProgressTracker                                     â”‚
    â”‚  â€¢ Atualiza status para "completed"                  â”‚
    â”‚  â€¢ Armazena caminho do arquivo                       â”‚
    â”‚  â€¢ Envia Ãºltimo progresso (100%)                     â”‚
    â”‚  â€¢ Fecha EventSource                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Browser                                             â”‚
    â”‚  â€¢ Recebe evento final                               â”‚
    â”‚  â€¢ Atualiza UI (100%)                                â”‚
    â”‚  â€¢ Mostra notificaÃ§Ã£o "Download concluÃ­do!"          â”‚
    â”‚  â€¢ Oferece download ou abrir arquivo                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


## ğŸ—ï¸ ESTRUTURA DE PASTAS RECOMENDADA

ytdln-open/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.js                          â­ Entry point (Electron)
â”‚   â”œâ”€â”€ stream-download-api.js           â­ API HTTP (Legacy)
â”‚   â”œâ”€â”€ progress-parser.js               â­ Parser de progresso
â”‚   â”œâ”€â”€ video-downloader.js              â­ Downloader base
â”‚   â”‚
â”‚   â””â”€â”€ api/                             âœ¨ NOVA ESTRUTURA
â”‚       â”œâ”€â”€ routes/
â”‚       â”‚   â””â”€â”€ download.routes.js       â†’ Definir rotas
â”‚       â”‚
â”‚       â”œâ”€â”€ controllers/
â”‚       â”‚   â””â”€â”€ download.controller.js   â†’ LÃ³gica HTTP
â”‚       â”‚
â”‚       â”œâ”€â”€ services/
â”‚       â”‚   â”œâ”€â”€ download.service.js      â†’ ServiÃ§os de download
â”‚       â”‚   â”œâ”€â”€ download-queue.js        â†’ Fila de processamento
â”‚       â”‚   â”œâ”€â”€ progress-tracker.js      â†’ Rastrear progresso
â”‚       â”‚   â””â”€â”€ sse-manager.js           â†’ Gerenciar SSE
â”‚       â”‚
â”‚       â”œâ”€â”€ models/
â”‚       â”‚   â””â”€â”€ download.model.js        â†’ Estrutura de dados
â”‚       â”‚
â”‚       â””â”€â”€ utils/
â”‚           â”œâ”€â”€ constants.js             â†’ Constantes
â”‚           â””â”€â”€ validators.js            â†’ ValidaÃ§Ãµes
â”‚
â”œâ”€â”€ browser-extension/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ popup.js                     â†’ Cliente JavaScript
â”‚   â”‚
â”‚   â””â”€â”€ public/
â”‚       â””â”€â”€ js/
â”‚           â””â”€â”€ download-client.js       â†’ Cliente REST API
â”‚
â””â”€â”€ docs/
    â””â”€â”€ API_ARCHITECTURE.md              â†’ Este documento

## ğŸ“‹ ESTADOS DO DOWNLOAD

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Status    â”‚  Phase      â”‚  DescriÃ§Ã£o                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ pending     â”‚ -           â”‚ Na fila, aguardando inÃ­cio        â”‚
â”‚ downloading â”‚ download    â”‚ Baixando chunks do vÃ­deo          â”‚
â”‚ merging     â”‚ merge       â”‚ Mergindo Ã¡udio + vÃ­deo (ffmpeg)   â”‚
â”‚ processing  â”‚ postproc    â”‚ PÃ³s-processamento (legenda, etc)  â”‚
â”‚ completed   â”‚ -           â”‚ âœ… Finalizado com sucesso         â”‚
â”‚ error       â”‚ -           â”‚ âŒ Erro durante processamento     â”‚
â”‚ cancelled   â”‚ -           â”‚ â¸ï¸  Cancelado pelo usuÃ¡rio        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


## ğŸ”„ ENDPOINTS REST

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. INICIAR DOWNLOAD                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /api/download                                            â”‚
â”‚                                                               â”‚
â”‚ Request Body:                                                 â”‚
â”‚ {                                                             â”‚
â”‚   "url": "https://example.com/video",                         â”‚
â”‚   "format": "best",              // best, worst, 720p, etc   â”‚
â”‚   "outputPath": "/downloads",    // Onde salvar              â”‚
â”‚   "audioOnly": false,            // Apenas Ã¡udio?             â”‚
â”‚   "subtitles": false             // Baixar legendas?          â”‚
â”‚ }                                                             â”‚
â”‚                                                               â”‚
â”‚ Response (200 OK):                                            â”‚
â”‚ {                                                             â”‚
â”‚   "taskId": "task_1705000000000_1",                           â”‚
â”‚   "status": "pending",                                        â”‚
â”‚   "message": "Download enfileirado"                           â”‚
â”‚ }                                                             â”‚
â”‚                                                               â”‚
â”‚ Response (400 Bad Request):                                   â”‚
â”‚ {                                                             â”‚
â”‚   "error": "URL invÃ¡lida",                                    â”‚
â”‚   "code": "INVALID_URL"                                       â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. CONSULTAR STATUS                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GET /api/download/status/:taskId                              â”‚
â”‚                                                               â”‚
â”‚ Response (200 OK):                                            â”‚
â”‚ {                                                             â”‚
â”‚   "taskId": "task_1705000000000_1",                           â”‚
â”‚   "status": "downloading",                                    â”‚
â”‚   "phase": "download",                                        â”‚
â”‚   "progress": 45.5,                    // Porcentagem        â”‚
â”‚   "speed": "5.23 MiB/s",                                      â”‚
â”‚   "eta": "00:23",                      // Tempo estimado      â”‚
â”‚   "total": "123.45 MiB",                                      â”‚
â”‚   "downloaded": "56.12 MiB",                                  â”‚
â”‚   "startTime": 1705000000000,                                 â”‚
â”‚   "elapsedTime": "01:15",                                     â”‚
â”‚   "outputPath": null,                  // null atÃ© completar  â”‚
â”‚   "error": null                                               â”‚
â”‚ }                                                             â”‚
â”‚                                                               â”‚
â”‚ Response (404 Not Found):                                     â”‚
â”‚ {                                                             â”‚
â”‚   "error": "Download nÃ£o encontrado",                         â”‚
â”‚   "code": "TASK_NOT_FOUND"                                    â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. PROGRESSO EM TEMPO REAL (Server-Sent Events)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GET /api/download/:taskId/sse                                 â”‚
â”‚                                                               â”‚
â”‚ Headers:                                                      â”‚
â”‚ Content-Type: text/event-stream                               â”‚
â”‚ Cache-Control: no-cache                                       â”‚
â”‚ Connection: keep-alive                                        â”‚
â”‚                                                               â”‚
â”‚ Event Stream (exemplo):                                       â”‚
â”‚ data: {"taskId":"task_..","status":"downloading",             â”‚
â”‚        "progress":10,"eta":"00:45",...}                       â”‚
â”‚                                                               â”‚
â”‚ data: {"taskId":"task_..","status":"merging",                 â”‚
â”‚        "progress":70,...}                                     â”‚
â”‚                                                               â”‚
â”‚ data: {"taskId":"task_..","status":"completed",               â”‚
â”‚        "progress":100,"outputPath":"/downloads/video.mp4"}    â”‚
â”‚                                                               â”‚
â”‚ event: error                                                  â”‚
â”‚ data: {"error":"Arquivo corrompido"}                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. CANCELAR DOWNLOAD (Opcional)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /api/download/:taskId/cancel                             â”‚
â”‚                                                               â”‚
â”‚ Response (200 OK):                                            â”‚
â”‚ {                                                             â”‚
â”‚   "taskId": "task_...",                                       â”‚
â”‚   "status": "cancelled",                                      â”‚
â”‚   "message": "Download cancelado"                             â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


## ğŸ” TRATAMENTO DE ERROS

Status Code    | SituaÃ§Ã£o
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
200 OK         | Sucesso
201 Created    | Recurso criado
400 Bad Request| Dados invÃ¡lidos
404 Not Found  | Download nÃ£o existe
409 Conflict   | Download jÃ¡ em progresso
500 Server     | Erro interno do servidor
503 Unavail.   | Servidor indisponÃ­vel (queue cheia)

Erro Response:
{
  "error": "DescriÃ§Ã£o do erro",
  "code": "ERRO_CODE",
  "timestamp": "2026-01-12T01:59:10Z",
  "taskId": "task_..." (se aplicÃ¡vel)
}


## âš¡ IMPLEMENTAÃ‡ÃƒO: QUEUE & WORKERS

O sistema usa uma fila (Queue) para processar downloads em background:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EXEMPLO DE FLUXO                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Cliente 1 â†’ POST /api/download         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚              â””â†’ Retorna taskId1 (200)   â”‚  Fila:         â”‚ â”‚
â”‚                                          â”‚  [task1]       â”‚ â”‚
â”‚  Cliente 2 â†’ POST /api/download         â”‚  [task2] (esp) â”‚ â”‚
â”‚              â””â†’ Retorna taskId2 (200)   â”‚  [task3] (esp) â”‚ â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  Cliente 3 â†’ POST /api/download         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚              â””â†’ Retorna taskId3 (200)   â”‚  Worker 1:     â”‚ â”‚
â”‚                                          â”‚  Processando   â”‚ â”‚
â”‚  Client 1 â†’ GET /api/download/status/1  â”‚  task1         â”‚ â”‚
â”‚             â””â†’ { status: downloading ..} â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  ApÃ³s 5 min:                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  [task1 completa]                       â”‚  Fila:         â”‚ â”‚
â”‚  Worker 1 pega task2                    â”‚  [task2]       â”‚ â”‚
â”‚                                          â”‚  [task3] (esp) â”‚ â”‚
â”‚  Client 2 â†’ GET /api/download/status/2  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â””â†’ { status: pending ..}     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                          â”‚  Worker 1:     â”‚ â”‚
â”‚  Client 1 â†’ GET /api/download/status/1  â”‚  task2 (novo)  â”‚ â”‚
â”‚             â””â†’ { status: completed ..}   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VANTAGENS:
âœ… Express nÃ£o Ã© bloqueado por downloads
âœ… MÃºltiplos downloads simultaneamente
âœ… Fila evita sobrecarga (CPU, I/O)
âœ… Progresso pode ser monitorado em tempo real


## ğŸ› ï¸ FERRAMENTAS UTILIZADAS

1. Express.js          â†’ Framework HTTP
2. yt-dlp             â†’ Download de vÃ­deo
3. ffmpeg             â†’ Muxing/conversÃ£o
4. child_process      â†’ Executar processos externos
5. EventEmitter       â†’ EmissÃ£o de eventos
6. SSE (Server-Sent Events) â†’ Progresso em tempo real


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PrÃ³ximo: Ver arquivo API_IMPLEMENTATION.js para cÃ³digo funcional completo
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
